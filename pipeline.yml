jobs:
- name: subway
  public: true
  plan:
  - get: cf-subway
    trigger: true
  - task: run-tests
    file: cf-subway/build.yml

- name: pilot
  serial: true
  public: true
  plan:
  - get: cf-subway
    trigger: true
    passed: [subway]
  - get: haash-broker
  - task: build-backend-broker
    file: cf-subway/scripts/build-backend-broker.yml
  - aggregate:
    - put: haash-broker-1
      params:
        manifest: build-backend-broker/manifest.yml
        current_app_name: haash-broker-1
    - put: haash-broker-2
      params:
        manifest: build-backend-broker/manifest.yml
        current_app_name: haash-broker-2
    - put: subway-broker
      params:
        manifest: cf-subway/manifest.yml
        current_app_name: test-subway
        environment_variables:
          BACKEND_BROKER_1: https://warreng:natedogg@haash-broker-1.cfapps.io
          BACKEND_BROKER_2: https://warreng:natedogg@haash-broker-2.cfapps.io

resources:
- name: cf-subway
  type: git
  source:
    uri: https://github.com/cloudfoundry-community/cf-subway.git
    branch: master

- name: haash-broker
  type: git
  source:
    uri: https://github.com/drnic/haash-broker.git
    branch: parameters

- name: subway-broker
  type: cf
  source:
    api: https://api.run.pivotal.io
    skip_cert_check: false
    username: {{cf-username}}
    password: {{cf-password}}
    organization: {{cf-org}}
    space: {{cf-space}}

- name: haash-broker-1
  type: cf
  source:
    api: https://api.run.pivotal.io
    skip_cert_check: false
    username: {{cf-username}}
    password: {{cf-password}}
    organization: {{cf-org}}
    space: {{cf-space}}
- name: haash-broker-2
  type: cf
  source:
    api: https://api.run.pivotal.io
    skip_cert_check: false
    username: {{cf-username}}
    password: {{cf-password}}
    organization: {{cf-org}}
    space: {{cf-space}}
